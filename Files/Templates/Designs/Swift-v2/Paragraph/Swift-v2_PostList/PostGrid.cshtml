@inherits Dynamicweb.Rendering.ViewModelTemplate<Dynamicweb.Frontend.ParagraphViewModel>
@using Dynamicweb.Frontend

@{
    string queryName = "PostsCurrentPage";
    string repositoryName = "Post";
    string layout = "PostGrid";
    int parentPageId = Model.Item.GetLink("ParentPage")?.PageId != null ? Model.Item.GetLink("ParentPage").PageId : Pageview.Page.ID;

    string queryPath =
    $"/dwapi/query?QueryName={queryName}&RepositoryName={repositoryName}&AreaId={Pageview?.Area.ID}&ParentPageID={parentPageId}";
    queryPath += !string.IsNullOrEmpty(Dynamicweb.Context.Current.Request.QueryString.Get("postq")) ?
    $"&postq={Dynamicweb.Context.Current.Server.UrlEncode(Dynamicweb.Context.Current.Request.QueryString.Get("postq"))}" :
    string.Empty;
}

<script>
    document.body.addEventListener('htmx:beforeSwap', function(e) {
        const triggeringElement = e.detail.requestConfig.elt;
        const fallbackSelector = triggeringElement.getAttribute('hx-response-error');

        if (fallbackSelector && (e.detail.xhr.status === 500 || e.detail.xhr.status === 404)) {
            const fallbackElement = document.querySelector(fallbackSelector);
            if (fallbackElement) {
                htmx.swap(e.detail.target, fallbackElement.innerHTML, 'innerHTML');
            }
        }
    });
</script>

<div>
    <div hx-get="@queryPath" 
        hx-trigger="intersect once" 
        hx-headers='{"x-dw-template": "/Designs/Swift-v2/QueryPublisher/@(layout).cshtml", "accept": "text/html"}'
        hx-response-error="#response-error-@(Model.ID)">
        <div class="d-grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr))">
            @for (var i = 0; i < 4; i++)
            {
                <div class="card" aria-hidden="true">
                    <img src="https://placehold.co/600x400" class="card-img-top" alt="...">
                    <div class="card-body">
                        <p class="card-text placeholder w-75"></p>
                    </div>
                </div>
            }
        </div>
    </div>
    <template id="response-error-@(Model.ID)">
        <div class="alert alert-dark w-100 text-center" role="alert">
            @Translate("No results found")
        </div>
    </template>
</div>