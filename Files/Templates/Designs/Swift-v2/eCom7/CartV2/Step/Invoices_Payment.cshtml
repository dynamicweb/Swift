@inherits Dynamicweb.Rendering.RazorTemplateBase<Dynamicweb.Rendering.RazorTemplateModel<Dynamicweb.Rendering.Template>>
@using Dynamicweb

@{
	var savedCards = GetLoop("SavedCards");
}

<header class="mb-4">
	<h1 class="h4 mb-0">@(Pageview.Page.GetDisplayName())</h1>
</header>

<form method="post">

	<h6 class="mb-3 fw-bold">@Translate("Selected transactions")</h6>

	<div class="card overflow-hidden mb-4">
		<div class="table-responsive" style="margin-bottom:-1px;">
			<table class="table table-md table-hover mb-0 align-middle fs-7"
				style="--bs-table-color: var(--bs-body-color);">
				<thead
					style="--bs-table-bg: rgba(var(--bs-body-color-rgb), .0275); --bs-table-color: rgba(var(--bs-body-color-rgb), 0.5);">
					<tr>
						<th>@Translate("Number")</th>
						<th>@Translate("Balance")</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var invoice in GetLoop("OrderLines"))
					{
						if (invoice.GetBoolean("Ecom:Order:OrderLine.IsProduct"))
						{
							string productNumber =
							!string.IsNullOrEmpty(invoice.GetString("Ecom:Order:OrderLine.ProductNumber")) ?
							invoice.GetString("Ecom:Order:OrderLine.ProductNumber") :
							invoice.GetString("Ecom:Order:OrderLine.ProductName");

							<tr class="position-relative">
								<td>@(productNumber)</td>
								<td class="fw-bold">
									@(invoice.GetString("Ecom:Order:OrderLine.TotalPriceWithProductDiscounts.PriceFormatted"))
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		</div>
	</div>

	<div class="d-flex justify-content-between align-items-center mb-3">
		<h6 class="m-0 fw-bold">@Translate("Payment options")</h6>
		<a href="/Default.aspx?ID=@GetPageIdByNavigationTag("SavedCardsPage")">@Translate("Manage your wallet")</a>
	</div>

	<div class="card overflow-hidden mb-4">
		<div class="table-responsive" style="margin-bottom:-1px;">
			<table class="table table-md table-hover mb-0 align-middle fs-7"
				style="--bs-table-color: var(--bs-body-color);">
				<thead
					style="--bs-table-bg: rgba(var(--bs-body-color-rgb), .0275); --bs-table-color: rgba(var(--bs-body-color-rgb), 0.5);">
					<tr>
						@if (savedCards.Count > 0)
						{
							<th class="pe-0" style="width:3rem;">&nbsp;</th>
						}
						<th>@Translate("Card")</th>
						<th>@Translate("Name")</th>
						<th>@Translate("Expires")</th>
					</tr>
				</thead>
				<tbody>
					@{
						string selectedCardId = GetString("Ecom:Order.SavedCardID");

						foreach (LoopItem card in savedCards)
						{
							bool isChecked = card.GetBoolean("Ecom:SavedCard.IsSelected");
							isChecked = string.IsNullOrEmpty(selectedCardId) && card.GetBoolean("Ecom:SavedCard.IsDefault") ? true : isChecked;

							<tr>
								<td class="pe-0">
									<div class="form-check mb-0">
										<input class="form-check-input" type="radio" name="EcomCartSavedCardID"
											id="EcomSavedCardID_@card.GetString("Ecom:SavedCard.ID")"
											value="@card.GetString("Ecom:SavedCard.ID")" checked="@isChecked"
											data-card-name="@card.GetString("Ecom:SavedCard.Name")">
									</div>
								</td>
								<td>
									<label for="EcomSavedCardID_@card.GetString("Ecom:SavedCard.ID")" class="form-check-label">
										@if (!string.IsNullOrEmpty(card.GetString("Ecom:SavedCard.Payment.Icon")))
										{
											if (card.GetString("Ecom:SavedCard.Payment.Icon.Clean").EndsWith(".svg",
											StringComparison.OrdinalIgnoreCase))
											{
												<span class="icon-2">
													@ReadFile(card.GetString("Ecom:SavedCard.Payment.Icon.Clean"))
												</span>
											}
											else
											{
												<img src="@card.GetString("Ecom:SavedCard.Payment.Icon.Clean")" class="me-2"
													style="max-width: 1.5rem; max-height: 1.5rem;"
													alt="@card.GetString("Ecom:SavedCard.CardType")">
											}
										}
										@card.GetString("Ecom:SavedCard.CardType") •••• •••• ••••
										@card.GetString("Ecom:SavedCard.Identifier").Substring(card.GetString("Ecom:SavedCard.Identifier").Length-4)
									</label>
								</td>
								<td>@(card.GetString("Ecom:SavedCard.Name"))</td>
								<td></td>
							</tr>
						}

						if( savedCards.Count < 1)
						{
							<tr class="position-relative">
								<td colspan="3">
									<div class="d-grid py-4">
										<span class="m-auto">
											<div class="d-grid rounded-circle m-auto" style="width:4rem;aspect-ratio:1;background-color:rgba(var(--bs-body-color-rgb), .0275);">
												<span class="icon-4 text-body text-muted">
													@ReadFile("/Files/Images/Icons/credit-card.svg")
												</span>
											</div>
											<div class="mt-3">@Translate("No cards found")</div>
										</span>
									</div>
								</td>
							</tr>
						}
					}

				</tbody>
			</table>
		</div>
	</div>

	<h6 class="mb-3 fw-bold">@Translate("Comment")</h6>

	<div class="card overflow-hidden mb-4">
		<div class="table-responsive" style="margin-bottom:-1px;">
			<textarea class="form-control" name="EcomOrderCustomerComment" id="EcomOrderCustomerComment"
				style="min-height: 100px"
				placeholder="@Translate("Add any additional information here")">@GetString("Ecom:Order.Customer.Comment.Clean")</textarea>
		</div>
	</div>

	<div class="card border-0 mb-4" style="--bs-card-bg: rgba(var(--bs-body-color-rgb), .0275);">
		<div class="card-body p-3">
			<div class="hstack justify-content-between">
				<h6 class="mb-0">@Translate("Selected invoices")</h6>
				<span class="text-price fw-bold">@GetString("Ecom:Order.OrderLines.TotalProductQuantity")</span>
			</div>
			<div class="hstack justify-content-between">
				<h6 class="mb-0">@Translate("Total payment amount")</h6>
				<span class="text-price fw-bold">@GetString("Ecom:Order.OrderLines.Total.Price")</span>
			</div>
		</div>
	</div>

	<div class="hstack gap-2 justify-content-end border-top pt-3 w-100 mb-6">
		<button class="btn btn-primary" type="submit" name="@GetString("CartV2.NextStepButtonName")"
			id="@GetString("CartV2.NextStepButtonName")" data-dw-button>@Translate("Complete payment")</button>
	</div>
</form>