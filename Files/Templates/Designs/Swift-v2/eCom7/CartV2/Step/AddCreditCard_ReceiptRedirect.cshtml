@inherits Dynamicweb.Rendering.RazorTemplateBase<Dynamicweb.Rendering.RazorTemplateModel<Dynamicweb.Rendering.Template>>
@using Dynamicweb

@* This template is here to trick the checkout to redirect correctly back to the customer center *@
@* This is only here to secure that we can use payment complexity from the chekcout to handle credit card creation *@

@{
    string redirectUrl = "/Default.aspx?ID=" + GetPageIdByNavigationTag("SavedCardsPage");
    
    // Retrieve cart ID from cookie (stored before external payment provider redirect)
    var currentCartCookie = Dynamicweb.Context.Current?.Request.GetCookie("CurrentCart");
    var currentCart = currentCartCookie?.Value;
    
    // Clean up the cookie after reading
    if (currentCartCookie != null && Dynamicweb.Context.Current?.Response != null)
    {
        Dynamicweb.Context.Current.Response.RemoveCookie("CurrentCart");
    }
    
    if (!string.IsNullOrEmpty(currentCart))
    {
        Dynamicweb.Ecommerce.Common.Context.SetCart(Dynamicweb.Ecommerce.Services.Orders.GetById(currentCart));
    }
}

<form x-init="window.location.href = '@(redirectUrl)'"></form>