@inherits ViewModelTemplate<PageViewModel>
@using Dynamicweb.Frontend
@using Dynamicweb.Rendering

@{
    int addCreditCardPageId = GetPageIdByNavigationTag("AddCreditCardPage");
    string addCreditCardPageUrl = addCreditCardPageId != 0 
        ? $"/Default.aspx?ID={addCreditCardPageId}"
        : string.Empty;

    var currentCart = Dynamicweb.Ecommerce.Common.Context.Cart?.Id;
    
    // Store cart ID in cookie for retrieval after external payment provider redirect
    if (currentCart != null && Dynamicweb.Context.Current?.Response != null)
    {
        var cookie = new Dynamicweb.Environment.Cookie("CurrentCart", currentCart.ToString())
        {
            HttpOnly = true,
            Secure = Dynamicweb.Context.Current.Request.IsSecureConnection,
            Expires = DateTime.Now.AddHours(1) // Expire after 1 hour
        };
        Dynamicweb.Context.Current.Response.SetCookie(cookie);
    }
}

<div class="modal fade" id="addCreditCardModal" tabindex="-1" aria-labelledby="AddCreditCard" aria-hidden="true" 
  hx-on::load="bootstrap.Modal.getOrCreateInstance(this).show();"
  x-on:shown-bs-modal.dot="
    const modalBody = $event.target.querySelector('.modal-body');
    if (modalBody && !modalBody.querySelector('#ordersubmit')) {
      htmx.trigger(modalBody, 'load-form');
    }
  "
  x-on:hidden-bs-modal.dot="
    bootstrap.Modal.getOrCreateInstance($event.target).dispose();
    const form = $event.target.querySelector('#ordersubmit');
    if (form) {
      form.remove();
    }
    $event.target.remove();
  ">
  <div class="modal-dialog pt-8">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@Translate("Name your card")</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Translate("Cancel")"></button>
      </div>
      <div class="modal-body"
           hx-get="@(addCreditCardPageUrl)"
           hx-trigger="load-form"
           hx-select="#ordersubmit"
           hx-swap="innerHTML"
           hx-indicator="#addCreditCardModalLoader">
        <div class="d-flex justify-content-center align-items-center py-4" id="addCreditCardModalLoader">
          <span class="htmx-indicator spinner-border spinner-border-sm" aria-hidden="true"></span>
        </div>
      </div>
    </div>
  </div>
</div>

